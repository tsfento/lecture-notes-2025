# Associations and Controllers in Rails

## Introduction

-   We are going to discuss associations in rails
-   We are going to discuss controllers in rails
-   We are going to continue making our api

## Associations in Rails

What are the different types of associations in Rails?
### has_one Association:
  - Used when one record in a table is associated with one record in another table.
  - Example: A user has one profile, and a profile belongs to a user.
  - Foreign key is typically in the "belongs_to" model.

### has_many Association:
  - Occurs when a single record in one table is linked to multiple records in another table.
  - Example: A user has many posts, but each post belongs to one user.
  - Foreign key is present in the model that "belongs_to" the other.

### has_many :through Association:
  - Connects two models through a third model.
  - Example: Patients and Physicians connected through Appointments.
  - Useful for when you need to work with the join model directly.

### has_and_belongs_to_many Association:
  - Establishes a direct many-to-many connection between two models without a join model.
  - Example: Authors and Books where authors can write many books, and books can have many authors.
  - Requires a join table, but no separate join model.

### Polymorphic Association:
  - Allows a model to belong to more than one other model using a single association.
  - Example: Comments that can belong to different models like Posts and Photos.

### Self-join Association:
  - Used when records in a table need to be associated with other records in the same table.
  - Example: Users being friends with other users.

## Controllers and Routes

### What are controllers and routes in Rails?

> Controllers are the middlemen between models and views. They are responsible for processing requests and sending responses. They are also responsible for handling the logic of the application. For example, if we want to create a user, the controller will handle the logic of creating a new user.

>Routes, on the other hand, are responsible for mapping URLs to controller actions. A controller action is a method that is defined in the controller's class. For example, if we want to create a user, we will make a POST request to the create action in the users controller.

> [Codelabs Learning Assistant Demo](https://chatgpt.com/g/g-68484cbcb348819181c3f4137b0b7c49-codelabs-learning-assistant)
>
> - Ask the assistant: What are the RESTful routes generated by resources :blogs in Rails?
> - Use the assistant's answer to reinforce the concept of RESTful routing and controller actions.

### What is RESTful routing and why is it beneficial to use?

>RESTful routing in Rails organizes routes around resources using standard HTTP verbs (GET, POST, PATCH/PUT, DELETE) mapped to conventional controller actions like index, show, create, update, and destroy. This provides consistency, improves readability, and leverages Rails conventions for easier development and maintenance.

### What are the RESTful routes for a given resource and their corresponding controller actions?

```
| HTTP Verb | Path       | Controller#Action | Used for                    |
| --------- | ---------- | ----------------- | --------------------------- |
| GET       | /users     | users#index       | display a list of all users |
| POST      | /users     | users#create      | create a new user           |
| GET       | /users/:id | users#show        | display a specific user     |
| PATCH/PUT | /users/:id | users#update      | update a specific user      |
| DELETE    | /users/:id | users#destroy     | delete a specific user      |
```

  - Controllers are the intermediaries between models and views.
  - Routes map URLs to controller actions.
  - Restful routing is a convention for defining routes and controller actions.
  - RESTful routing is beneficial because it provides a consistent and predictable way to define routes and actions.
  - Common controller actions: create, index, show, update, destroy.
  - Testing controller actions is done using tools like Postman.

### RESTful Controller Actions:
  - Create: Adds a new record to the database.
  - Index: Displays a list of all records.
  - Show: Displays a specific record.
  - Update: Modifies an existing record.
  - Destroy: Deletes a specific record.

This is also called CRUD functionality, and it relates to RESTful routes.

### RESTful Routes:
  - GET /posts: Index action to display all posts.
  - GET /posts/:id: Show action to display a specific post.
  - POST /posts: Create action to add a new post.
  - PUT /posts/:id: Update action to modify an existing post.
  - DELETE /posts/:id: Destroy action to delete a specific post.

### What is postman?:
  - Postman is a tool for testing API endpoints.
  - Send various request types (GET, POST, PUT, DELETE) to assess controller actions.

## Live Coding - Beta Blogs
Many to Many Relationship with has_and_belongs_to_many association

A blog has many categories, and a category has many blogs.

A has_and_belongs_to_many association creates a direct many-to-many connection between two models without a join model. Don't confuse this with a has_many :through association, which requires a join model.

Create a category model:

```bash
rails g model Category name:string
```

Create a blogs_categories join table:

```bash
rails generate migration CreateJoinTableBlogCategory blog category
```

It is an array literal for an array of symbols. It does the same thing in relation to symbol arrays as ' does to strings.

[Link](https://en.wikibooks.org/wiki/Ruby_Programming/Syntax/Literals#The_%_Notation)

```bash
rails db:migrate
```

app/models/category.rb

```ruby
class Category < ApplicationRecord
  has_and_belongs_to_many :blogs
end
```

```ruby
class Blog < ApplicationRecord
  has_and_belongs_to_many :categories
  belongs_to :user
  
  validates :title, presence: true
  validates :content, presence: true
end
```

Let's go ahead and create some data in the rails console to demonstrate the many to many relationship.

```bash
category1 = Category.create(name: "Ruby")
category2 = Category.create(name: "Rails")

blog = Blog.first 

blog.categories << category1
blog.categories << category2

blog.categories

category = Category.first
category.blogs 
```

### Controllers and Routes

Controllers handle requests and responses. They are responsible for processing requests, performing CRUD operations on models, and returning responses. Of course, there are no views in an API, so controllers are responsible for returning JSON responses.

```bash
rails g controller Blogs
```

#### Index Action
The index action is responsible for returning a list of all records.

#### Routes (config/routes.rb):

```ruby
Rails.application.routes.draw do
  resources :blogs, only: [:index]
end
```

#### Blogs Controller (app/controllers/blogs_controller.rb):

```ruby
class BlogsController < ApplicationController
  def index
    blogs = Blog.all

    render json: blogs
  end
end
```

```bash
rails s
```
- Use postman to send a GET request to http://localhost:3000/blogs

#### Show Action
The show action is responsible for returning a specific record.

#### Routes (config/routes.rb):

```ruby
Rails.application.routes.draw do
  resources :blogs, only: [:index, :show]
end
```

#### Blogs Controller (app/controllers/blogs_controller.rb):

```ruby
class BlogsController < ApplicationController
  def index
    blogs = Blog.all

    render json: blogs
  end

  def show
    blog = Blog.find(params[:id])

    render json: blog
  end
end
```

#### Create Action
The create action is responsible for adding a new record to the database.

#### Routes (config/routes.rb):

```ruby
Rails.application.routes.draw do
  resources :blogs, only: [:index, :show, :create]
end
```

#### Blogs Controller (app/controllers/blogs_controller.rb):

```ruby
class BlogsController < ApplicationController
  def index
    blogs = Blog.all

    render json: blogs
  end

  def show
    blog = Blog.find(params[:id])

    render json: blog
  end

  def create
    blog = Blog.create(blog_params)

    render json: blog
  end

  private

  def blog_params
    params.permit(:title, :content, :user_id)
  end
end
```

- Use postman to send a POST request to http://localhost:3000/blogs with the following body:

```json
{
    "title": "Third blog post",
    "content": "This is my third post.",
    "user_id": 1
}
```

#### Rails' Parameter Wrapping:
Rails has a feature called "Parameter Wrapping" which, in some cases (especially with JSON or XML payloads), wraps your parameters in a top-level key matching the model name.
For example, if you send a JSON payload like { "name": "example" }, Rails might wrap it in "model_name": { "name": "example" } where "model_name" corresponds to the controller you're interacting with.
If your permit list doesn't include this wrapper key, you'll see the "Unpermitted parameter" message for it.

#### Update Action
The update action is responsible for modifying an existing record.

#### Routes (config/routes.rb):

```ruby
Rails.application.routes.draw do
  resources :blogs, only: [:index, :show, :create, :update]
end
```

#### Blogs Controller (app/controllers/blogs_controller.rb):

```ruby
class BlogsController < ApplicationController
.
.
.
  def update
    blog = Blog.find(params[:id])
    blog.update(blog_params)

    render json: blog
  end
end
```

- Use postman to send a PUT request to http://localhost:3000/blogs/1 with the following body:

```json
{
    "title": "First Post Updated",
    "content": "This is my first blog updated.",
    "user_id": 1
}
```

#### Destroy Action
The destroy action is responsible for deleting a specific record.

#### Routes (config/routes.rb):

```ruby
Rails.application.routes.draw do
  resources :blogs, only: [:index, :show, :create, :update, :destroy]
end
```

#### Blogs Controller (app/controllers/blogs_controller.rb):

```ruby
class BlogsController < ApplicationController
.
.
.
  def destroy
    blog = Blog.find(params[:id])
    blog.destroy

    render json: blog
  end
end
```

- Use postman to send a DELETE request to http://localhost:3000/blogs/1

> [Codelabs Learning Assistant Demo](https://chatgpt.com/g/g-68484cbcb348819181c3f4137b0b7c49-codelabs-learning-assistant)
>
> - Copy the code for the has_and_belongs_to_many association and ask: Can you explain the difference between has_and_belongs_to_many and has_many :through?
> - Discuss the assistant's answer with the class and clarify any confusion about join models.


# Any questions?